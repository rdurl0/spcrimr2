---
title: "VImportando dados: _Shapefile_ - malha de municípios do estado de São Paulo"
author: "Vignette Author"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Shapefile}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

## `Shapefile`

### Baixando os dados e salvando

Primeiro, criamos uma pasta onde os arquivos serão salvos:
```{r warning=FALSE, eval=FALSE}
rm(list=ls())
dir.create(  "./raw_data/shp", showWarnings = FALSE)
```

Em seguida, montamos uma _url_ para _download_ dos arquivos do [IBGE](https://downloads.ibge.gov.br/downloads_geociencias.htm):
```{r warning=FALSE}
u_ibge <- paste0("ftp://geoftp.ibge.gov.br/organizacao_do_territorio/",
                 "malhas_territoriais/malhas_municipais/",
                 "municipio_2015/UFs/SP/sp_municipios.zip",
           collapse = "")
```

Pega a _url_ do site e salva no diretório criado:
```{r warning=FALSE, eval=FALSE}
httr::GET(u_ibge,                              # lê a url
           # httr::write_disk("./shp/pr.zip")  # salva em disco
          ) 

# dezipa os arquivo com unzip()
unzip("./raw_data/shp/sp.zip", exdir = "./raw_data/shp/sp")
```

```{r echo=FALSE}
my_shp_path <- "C:/Users/rauld/OneDrive/Documentos/[documentos]Raul/economia_do_crime/raw_data/shp/sp/35MUE250GC_SIR.shp"
```


***

### Ler objeto `sf`

Para ler esses arquivos num objeto do R, utilizamos a função `sf::st_read()`:

```{r, warning=FALSE, message=FALSE, fig.height=3, fig.width=3, fig.align='center'}
library(sf)
library(tidyverse)
library(janitor)
sf_sampa <- st_read(my_shp_path, quiet = TRUE) %>%
               clean_names() %>% 
               mutate(nm_municip = as.character(nm_municip),
                      cod_ibge   = as.integer(paste0(cd_geocmu))) %>% 
               select(-cd_geocmu) %>%
               arrange(nm_municip) %>% glimpse()                              


plot(sf_sampa[,"nm_municip"], key.pos = NULL,
     main = list("Malha de municípios no Estado de São Paulo", cex = .7))
```

***

### Pacote `AbjMaps`:

```{r, warning=FALSE, fig.height=3, fig.width=3, fig.align='center'}

# TODO: muni_comarcas_completo

sf_sampa <- abjMaps::d_sf
sf_sampa

```


```{r echo=TRUE, fig.height=8, fig.width=7, fig.align='center'}
### Montando os gráficos
 # liste os mapas
mapas <- sf_sampa$sf

 # e faça um vetor para cada título do gráfico
titulos <- c(
  "Municipios",
  "Comarcas",
  "Circunscrições Judiciárias",
  "Regiões Administrativas"
   )

graficos <- purrr::map2(mapas, titulos, ~{
  ggplot(.x) +        # cria o ggplot
    geom_sf() +       # desenha o mapa
    ggtitle(.y) +     # adiciona o título
    theme_minimal()   # deixa o fundo mais bonitinho
})

gridExtra::grid.arrange(grobs = graficos)
```

***
## Referências

__Unindo mapas: the _tidy_ way__. 2017. Blog do [Curso-R](http://curso-r.com/blog/2017/11/24/2017-11-23-union-sf/). Último acesso em: 12/07/2018.

J. Trecenti and F. Correa (2017). abjMaps: Organizing Data To Create Jurimetric Maps. R package version 0.1.9000.

***

FIM !